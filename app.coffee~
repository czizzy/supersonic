##
 # Module dependencies.
 #

configArgs = require('./config.coffee').config
express = require 'express'
form = require 'connect-form'
router = require './router.coffee'
mongo = require 'mongoskin'
mongoStore = require 'connect-mongodb'
Server = require('mongodb').Server
app = module.exports = express.createServer()
app.db = db = mongo.db configArgs.mongo.host + ':' + configArgs.mongo.port + '/' + configArgs.mongo.dbname + '?auto_reconnect'
#app.db = db = mongo.db 'localhost:27017/supersonic?auto_reconnect'
server_config = new Server configArgs.mongo.host, configArgs.mongo.port, {auto_reconnect: true}
#model = require './model.coffee'
#db.open ()->

# Configuration

app.configure () ->
    app.set('views', __dirname + '/views')
    app.set('view engine', 'jade')
    app.use express.bodyParser()
    app.use express.cookieParser()
    app.use form({keepExtensions: true})
    app.use express.session {store: new mongoStore({server_config: server_config, repeatInterval: 3000, dbname:'supersonic'}), secret: 'supersonic'}
    #app.use express.session {store: new mongoStore({db:db.db, repeatInterval: 3000}), secret: 'supersonic'}
    app.use(express.methodOverride())
    app.use(app.router)
    app.use(express.static(__dirname + '/public'))

app.configure 'development', () ->
    app.use(express.errorHandler({ dumpExceptions: true, showStack: true }))


app.configure 'production', () ->
  app.use(express.errorHandler())

# Routes
router.route app

app.listen(3000)
console.log("Express server listening on port %d in %s mode", app.address().port, app.settings.env)
